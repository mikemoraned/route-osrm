<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Basic</title>
    <link rel="shortcut icon" href="http://cartodb.com/assets/favicon.ico" />
    <style>
        html, body, #map {
            height: 100%;
            padding: 0;
            margin: 0;
        }
    </style>

    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.css" />

</head>
<body>
    <div id="map"></div>

    <script src="http://cdn.leafletjs.com/leaflet/v0.7.7/leaflet.js"></script>
    <script src="ngeohash.js"></script>

    <script>
        function main() {
            var map = L.map('map').setView([51.505, -0.09], 13);

            L.tileLayer('http://tile.stamen.com/toner/{z}/{x}/{y}.png', {
                attribution: 'Stamen'
            }).addTo(map);

            var marker = L.marker([51.5, -0.09]).addTo(map);

            var circle = L.circle([51.508, -0.11], 500, {
                color: 'red',
                fillColor: '#f03',
                fillOpacity: 0.5
            }).addTo(map);

            var boxes = {};

            function hideIfNotInside(e, hash) {
                var box = boxes[hash];
                if (box) {
                    box.hideIfNotInside(e.latlng);
                }
            }

            function onMouseout(e, hash) {
                hideIfNotInside(e, hash);

                if (hash.length > 1) {
                    var parentHash = hash.substring(0, hash.length - 1);
                    onMouseout(e, parentHash);
                }
                for (var prop in boxes) {
                    if( boxes.hasOwnProperty( prop ) ) {
                        if (prop != hash && prop.length == hash.length) {
                            hideIfNotInside(e, prop);
                        }
                    }
                }
            }

            function newBox(map, hash) {
                var bb = NGeoHash.decode_bbox(hash);
                var minlat = bb[0]; var minlon = bb[1]; var maxlat = bb[2]; var maxlon = bb[3];
                var southWest = L.latLng(minlat, minlon),
                        northEast = L.latLng(maxlat, maxlon),
                        bounds = L.latLngBounds(southWest, northEast);

                var rect = L.rectangle(bounds, {color: "#ff7800", weight: 1});
                console.dir(rect);

                var visible = false;

                rect.on({
                    mouseout: function(e) {
                        onMouseout(e, hash);
                    }
                });

                return {
                    hideIfNotInside: function(latlng) {
                        if (!bounds.contains(latlng)) {
                            console.log("remove " + rect);
                            map.removeLayer(rect);
                            visible = false;
                        }
                    },
                    show: function() {
                        if (!visible) {
                            rect.addTo(map);
                            visible = true;
                        }
                    }
                }
            }

//            function showGeoHash(hash, parent) {
//                var bb = NGeoHash.decode_bbox(hash);
//                var minlat = bb[0]; var minlon = bb[1]; var maxlat = bb[2]; var maxlon = bb[3];
//                var southWest = L.latLng(minlat, minlon),
//                        northEast = L.latLng(maxlat, maxlon),
//                        bounds = L.latLngBounds(southWest, northEast);
//                var rect = L.rectangle(bounds, {color: "#ff7800", weight: 1});
//                console.dir(rect);
//                rect.addTo(map);
//
//                var box = {};
//                box.onMouseout = function(e) {
//                    if (!bounds.contains(e.latlng)) {
//                        console.log("remove " + rect);
//                        map.removeLayer(rect);
//                        boxes[hash] = null;
//                    }
//                    if (parent) {
//                        parent.onMouseout(e);
//                    }
//                };
//
//                rect.on({
//                    mouseout: box.onMouseout
//                });
//
//                return box;
//            }

            function findOrCreateBox(map, hash) {
                var box = boxes[hash];
                if (box) {
                    return box;
                }
                else {
                    box = newBox(map, hash);
                    boxes[hash] = box;
                    return box;
                }
            }

            function addBoxes(e) {
                console.log(e);
                console.dir(boxes);
                for (var depth = 1; depth <= 6; depth++) {
                    var hash = NGeoHash.encode(e.latlng.lat, e.latlng.lng, depth);
                    var box = findOrCreateBox(map, hash);
                    box.show();
                }
            }

//            map.on('click', addBoxes);
            map.on('mousemove', addBoxes);
        }
        window.onload = main;
    </script>
</body>
</html>